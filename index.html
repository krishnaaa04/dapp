<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Voting App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-lg p-8 space-y-8">
        <!-- Header -->
        <div>
            <h1 class="text-3xl font-bold text-center text-gray-900">Blockchain Voting System</h1>
            <p class="text-center text-gray-500 mt-2">A decentralized and transparent way to vote.</p>
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-gray-200">
            <button id="creator-tab-button" class="tab-button flex-1 py-3 px-4 text-center font-semibold text-gray-600 border-b-2 border-transparent hover:bg-gray-50 transition active" onclick="showView('creator-view')">
                I'm a Creator
            </button>
            <button id="voter-tab-button" class="tab-button flex-1 py-3 px-4 text-center font-semibold text-gray-600 border-b-2 border-transparent hover:bg-gray-50 transition" onclick="showView('voter-view')">
                I'm a Voter
            </button>
        </div>

        <!-- Creator View -->
        <div id="creator-view" class="space-y-8">
            <div class="p-6 bg-gray-50 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold mb-4">1. Create a New Poll</h2>
                <form id="create-poll-form" class="space-y-4">
                    <input type="text" id="question" placeholder="Poll Question" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    <textarea id="options" placeholder="Enter options, separated by commas (e.g., Yes, No, Maybe)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" required></textarea>
                    <textarea id="voters" placeholder="Enter eligible voter IDs, separated by commas" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" required></textarea>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Create Poll</button>
                </form>
                <div id="creator-info" class="mt-4 p-4 bg-blue-100 text-blue-800 rounded-lg hidden break-words"></div>
            </div>

            <div class="p-6 bg-gray-50 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold mb-4">2. Manage Your Poll</h2>
                <form id="manage-poll-form" class="space-y-4">
                    <input type="text" id="manage-poll-id" placeholder="Poll ID" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <input type="text" id="creator-id" placeholder="Your Secret Creator ID" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <div class="flex space-x-4">
                         <button type="button" onclick="endPoll()" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition">End Poll</button>
                         <button type="button" onclick="getResults(true)" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition">Get Results</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Voter View -->
        <div id="voter-view" class="hidden space-y-6">
            <div class="p-6 bg-gray-50 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold mb-4">Access a Poll to Vote</h2>
                <form id="access-poll-form" class="space-y-4">
                    <input type="text" id="voter-poll-id" placeholder="Poll ID" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <input type="text" id="voter-id" placeholder="Your Voter ID" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">Access Poll</button>
                </form>
            </div>
            <div id="voting-area" class="hidden p-6 bg-gray-50 rounded-lg border border-gray-200 space-y-4"></div>
        </div>
        
        <!-- Universal Message/Result Area -->
        <div id="message-area" class="p-4 rounded-lg text-center font-medium hidden"></div>

    </div>

    <script>
        const API_URL = 'http://127.0.0.1:5000';

        // --- View Switching Logic ---
        function showView(viewId) {
            document.getElementById('creator-view').classList.add('hidden');
            document.getElementById('voter-view').classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
            
            document.getElementById('creator-tab-button').classList.remove('active');
            document.getElementById('voter-tab-button').classList.remove('active');
            document.getElementById(viewId.replace('-view', '-tab-button')).classList.add('active');

            clearMessages();
        }

        // --- Message Display Logic ---
        function showMessage(message, isError = false) {
            const messageArea = document.getElementById('message-area');
            messageArea.textContent = message;
            messageArea.className = `p-4 rounded-lg text-center font-medium ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
            messageArea.classList.remove('hidden');
        }
        
        function clearMessages() {
            const messageArea = document.getElementById('message-area');
            messageArea.textContent = '';
            messageArea.classList.add('hidden');
            document.getElementById('creator-info').classList.add('hidden');
        }

        // --- Creator Functions ---
        document.getElementById('create-poll-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            clearMessages();
            const question = document.getElementById('question').value;
            const options = document.getElementById('options').value;
            const voters = document.getElementById('voters').value;

            try {
                const response = await fetch(`${API_URL}/create_poll`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, options, voters })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to create poll.');

                const creatorInfo = document.getElementById('creator-info');
                creatorInfo.innerHTML = `
                    <p class="font-semibold">Poll Created! Save these details:</p>
                    <p><strong>Poll ID:</strong> ${data.poll_id}</p>
                    <p><strong>Creator ID:</strong> ${data.creator_id}</p>
                `;
                creatorInfo.classList.remove('hidden');
                document.getElementById('manage-poll-id').value = data.poll_id;
                document.getElementById('creator-id').value = data.creator_id;
            } catch (error) {
                showMessage(error.message, true);
            }
        });

        async function endPoll() {
            clearMessages();
            const pollId = document.getElementById('manage-poll-id').value;
            const creatorId = document.getElementById('creator-id').value;

            if (!pollId || !creatorId) {
                showMessage('Poll ID and Creator ID are required.', true);
                return;
            }

            try {
                const response = await fetch(`${API_URL}/end_poll`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ poll_id: pollId, creator_id: creatorId })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || data.message || 'Failed to end poll.');
                showMessage(data.message, false);
            } catch (error) {
                showMessage(error.message, true);
            }
        }

        // --- Voter & Results Functions ---
        document.getElementById('access-poll-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            clearMessages();
            const pollId = document.getElementById('voter-poll-id').value;
            const voterId = document.getElementById('voter-id').value;
            
            if (!pollId || !voterId) {
                 showMessage('Please provide both Poll ID and Voter ID.', true);
                 return;
            }
            
            try {
                const response = await fetch(`${API_URL}/poll_status/${pollId}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Could not fetch poll status.');

                if (data.is_active) {
                    displayVotingOptions(data.question, data.options, pollId, voterId);
                } else {
                    showMessage('This poll has ended. Fetching results...');
                    await getResults(false);
                }
            } catch (error) {
                showMessage(error.message, true);
            }
        });
        
        function displayVotingOptions(question, options, pollId, voterId) {
            const votingArea = document.getElementById('voting-area');
            let optionsHtml = `<h3 class="text-lg font-semibold">${question}</h3><div class="space-y-2">`;
            options.forEach(option => {
                optionsHtml += `
                    <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-gray-100 cursor-pointer">
                        <input type="radio" name="vote-option" value="${option}" class="mr-3 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <span>${option}</span>
                    </label>
                `;
            });
            optionsHtml += `</div><button onclick="castVote('${pollId}', '${voterId}')" class="w-full mt-4 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">Cast Your Vote</button>`;
            votingArea.innerHTML = optionsHtml;
            votingArea.classList.remove('hidden');
        }

        async function castVote(pollId, voterId) {
            clearMessages();
            const selectedOption = document.querySelector('input[name="vote-option"]:checked');
            if (!selectedOption) {
                showMessage('Please select an option to vote.', true);
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        poll_id: pollId,
                        voter_id: voterId,
                        selection: selectedOption.value
                    })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to cast vote.');
                
                document.getElementById('voting-area').innerHTML = '';
                document.getElementById('voting-area').classList.add('hidden');
                showMessage(data.message, false);
            } catch(error) {
                showMessage(error.message, true);
            }
        }

        async function getResults(isCreator) {
             if(!isCreator) clearMessages();
             const pollId = isCreator ? document.getElementById('manage-poll-id').value : document.getElementById('voter-poll-id').value;
             const creatorId = isCreator ? document.getElementById('creator-id').value : null;

             if (!pollId) {
                 showMessage('Poll ID is required to see results.', true);
                 return;
             }
             if (isCreator && !creatorId) {
                showMessage('Creator ID is required for this action.', true);
                return;
             }

             try {
                const response = await fetch(`${API_URL}/results`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ poll_id: pollId, creator_id: creatorId })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Could not fetch results.');
                
                displayResults(data);

             } catch(error) {
                showMessage(error.message, true);
             }
        }
        
        function displayResults(data) {
            const votingArea = document.getElementById('voting-area');
            let resultsHtml = `<h3 class="text-lg font-semibold">${data.question}</h3>`;
            resultsHtml += `<p class="text-sm text-gray-600 mb-4">Status: ${data.is_active ? 'Active' : 'Ended'} | Total Votes: ${data.total_votes}</p>`;
            resultsHtml += `<div class="space-y-3">`;

            for (const [option, votes] of Object.entries(data.results)) {
                 const percentage = data.total_votes > 0 ? ((votes / data.total_votes) * 100).toFixed(1) : 0;
                 resultsHtml += `
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="font-medium text-gray-700">${option}</span>
                            <span class="text-sm font-semibold text-gray-600">${votes} votes (${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-blue-600 h-4 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                 `;
            }
            resultsHtml += '</div>';
            
            // For voters, show results in their voting area.
            // For creators, show results in the general message area at the bottom.
            if(document.getElementById('voter-view').classList.contains('hidden')) {
                const messageArea = document.getElementById('message-area');
                messageArea.innerHTML = resultsHtml;
                messageArea.className = 'p-6 rounded-lg bg-gray-50 border border-gray-200 w-full text-left';
                messageArea.classList.remove('hidden');
            } else {
                votingArea.innerHTML = resultsHtml;
                votingArea.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
